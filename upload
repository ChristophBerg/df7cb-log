#!/bin/sh

GIT=git

while getopts "n" opt ; do
  case $opt in
    n) GIT="" ;;
    *) exit 5 ;;
  esac
done
# shift away args
shift $((OPTIND - 1))

set -eux

git pull --ff-only

( cd wsjtx; ./import )
( cd sql; ./dump )
( cd lotw
  YEAR=$(date +%Y)
  LOG=df7cb-$YEAR.adif
  ./export-adif $YEAR $LOG
  ./tqsl-upload $LOG
  ./clublog-upload $LOG
  ./dcl-upload $LOG
  ./eqsl-upload $LOG &
)

if [ "$GIT" ]; then
  git add -u
  git commit -m "Log upload"
  git push
fi
