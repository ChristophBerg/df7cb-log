#!/usr/bin/python3

from decimal import Decimal
import getopt
import sys
import psycopg2

opts, args = getopt.getopt(sys.argv[1:], "n")
noop = False

for o, a in opts:
    if o == '-n':
        noop = True
    else:
        assert False, "Unknown option %s" % (o)

if not noop:
    conn = psycopg2.connect("service=cb")
    cur = conn.cursor()

#40CW  14-Apr-19 08:11 0002  LY3B           599  599  29            LY   29  0   7029.1

for line in sys.stdin:
    if line[23] != '0':
        Exception('serial does not start with 0')

    qrg = Decimal(line[79:87]) / 1000

    sql = "INSERT INTO LOG (start, call, qrg, rsttx, rstrx, contest) " + \
          "VALUES (%s, %s, %s, %s, %s, %s)"
    data = (line[7:22],              # date+time
            line[29:43].rstrip(),    # call
            qrg,                     # qrg

            # my rst:
            line[44:47]+line[24:27], # my rst + serial (3 digits)
            #line[44:47]+'28',       # my rst + my ITU zone
            #line[44:47]+'42',       # my rst + my age
            #'JO31',

            # their rst:
            line[49:52]+line[54:67].rstrip(), # their rst + serial
            #line[54:64].rstrip(),

            args[0]) # contest name
    print (sql % data)
    if not noop:
        cur.execute(sql, data)

if not noop:
    conn.commit()
